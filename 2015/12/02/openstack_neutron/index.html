<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description"/><title>OpenStack 平台 Neutron 服务初探 | NAP</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/pure-min.css"/><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"/><link rel="stylesheet" type="text/css" href="/css/style.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">OpenStack 平台 Neutron 服务初探</h1><a id="logo" href="/">NAP</a><p class="description">Next Application Platform</p></div><div id="nav-menu"><a href="/" class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/atom.xml"><i class="icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">OpenStack 平台 Neutron 服务初探</h1><div class="post-meta">2015-12-02 | <span class="categories">分类于<a href="/categories/OpenStack/"> OpenStack</a></span></div><span data-thread-key="2015/12/02/openstack_neutron/" class="ds-thread-count"></span><div class="post-content"><blockquote>
<p>之前搭建了一个两个结点的 OpenStack 集群，老板说太简单了太 low 了，于是最近又重新搭建了一个四个结点的 OpenStack 集群。其中包含一个 Controller 结点，一个 Network 结点和两个 Compute 结点。其中 Network 结点主要运行 OpenStack 中的网络服务，即 Neutron 组件。下面对这个集群的部署过程做一下总结，并且简单介绍一下 Neutron 服务。</p>
</blockquote>
<a id="more"></a>
<h2 id="扩展 Compute 结点"><a href="# 扩展 Compute 结点" class="headerlink" title="扩展 Compute 结点"></a>扩展 Compute 结点 </h2><p> 扩展 Compute 结点相对来说是比较简单的。并且所有 Computer 节点的部署过程都是相同的，详细信息请参考上一篇。</p>
<h2 id="部署 Network 结点"><a href="# 部署 Network 结点" class="headerlink" title="部署 Network 结点"></a>部署 Network 结点 </h2><h3 id="开始之前"><a href="# 开始之前" class="headerlink" title="开始之前"></a> 开始之前 </h3><p> 在上一篇中，我们将 Neutron 服务的所有代理都放在了 Controller 组件里面，这些代理包括：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">Linux</span>网桥代理没建立 layer-<span class="number">2</span>虚拟网络，为实例提供 VXLAN 通道并处理安全组问题 (security groups)。</div><div class="line"><span class="symbol">DHCP</span> 代理，用于在创建实例时分配 <span class="built_in">IP</span> 地址。</div><div class="line"><span class="symbol">L3</span>代理，为虚拟网络提供路由和 NAT 服务。</div><div class="line"><span class="symbol">Metadata</span>代理，提供配置信息，如实例的证书等。</div></pre></td></tr></table></figure>
<p>我们想把上述代理都放在 Network 结点中，即将 Neutron 组件单独运行在一个结点中。我们的解决思路是尝试着分别将每个代理依次从 Controller 结点迁移到 Network 结点中。在此之前，我们首先将与各个代理相关的配置文件项列出来，并给予一些说明。</p>
<ul>
<li>ML2 插件配置项(配置文件为 /etc/neutron/plugins/ml2/ml2_conf.ini)</li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="attr">type_drivers</span> = flat,vlan,vxlan</div><div class="line"><span class="attr">tenant_network_types</span> = vxlan</div><div class="line"><span class="attr">mechanism_drivers</span> = linuxbridge,l2population</div><div class="line"><span class="attr">extension_drivers</span> = port_security</div><div class="line"><span class="attr">flat_networks</span> = public</div><div class="line"><span class="attr">vni_ranges</span> = <span class="number">1</span>:<span class="number">1000</span></div><div class="line"><span class="attr">enable_ipset</span> = <span class="literal">True</span></div></pre></td></tr></table></figure>
<p>在 ml2 插件的配置项中，主要是开启了 flat,vlan,vxlan 网络，其中私有网络 (tenant) 使用的是 vxlan 隧道，具体为下图所示。我们看到 VXLAN 隧道在网桥代理中，我们领 management network 的 ip 地址赋给 VXLAN 的网卡。而 flat 网络是 OpenStack 网络中的一种工作机制。Flat 模式指定一个子网，规定虚拟机实例能使用的 ip 范围，也就是一个 ip 池，创建实例时，从 ip 池中取出一个有效的 ip 为虚拟机分配，并且在虚拟机启动时注入虚拟机镜像。在这里，给 Flat 网命名为 public。</p>
<p><img src="/images/openstack-network-connect.png" alt=""></p>
<ul>
<li>Linux 网桥代理配置</li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="attr">physical_interface_mappings</span> = public:eth0 </div><div class="line"><span class="attr">enable_vxlan</span> = <span class="literal">True</span> </div><div class="line"><span class="attr">local_ip</span> = OVERLAY_INTERFACE_IP_ADDRESS</div><div class="line"><span class="attr">l2_population</span> = <span class="literal">True</span></div><div class="line"><span class="attr">prevent_arp_spoofing</span> = <span class="literal">True</span></div><div class="line"><span class="attr">enable_security_group</span> = <span class="literal">True</span></div><div class="line"><span class="attr">firewall_driver</span> = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver</div></pre></td></tr></table></figure>
<p>在 Linux 网桥的配置项中，我们开启了 VXLAN 通道，并且指定 ip 为 management work 中的 ip，并将 public 网络绑定在 eth0 网卡(public network)。</p>
<ul>
<li>L3 代理配置</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">interface_driver = neutron<span class="selector-class">.agent</span><span class="selector-class">.linux</span><span class="selector-class">.interface</span><span class="selector-class">.BridgeInterfaceDriver</span></div><div class="line">external_network_bridge =</div></pre></td></tr></table></figure>
<ul>
<li>DHCP 代理配置</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">interface_driver = neutron<span class="selector-class">.agent</span><span class="selector-class">.linux</span><span class="selector-class">.interface</span><span class="selector-class">.BridgeInterfaceDriver</span></div><div class="line">dhcp_driver = neutron<span class="selector-class">.agent</span><span class="selector-class">.linux</span><span class="selector-class">.dhcp</span><span class="selector-class">.Dnsmasq</span></div><div class="line">enable_isolated_metadata = True</div></pre></td></tr></table></figure>
<p>在上述两个代理中，我们都在 interface_driver 项中选择了 Linux 网桥的驱动。</p>
<ul>
<li>Metadata 代理配置，主要为与 keystone 和 nova 之间关于认证的一些 <a href="http://docs.openstack.org/liberty/install-guide-ubuntu/neutron-controller-install.html" target="_blank" rel="external"> 配置项</a>，没有太多需要说明的。</li>
</ul>
<h3 id="将 L3 代理迁移到 Network 结点"><a href="# 将 L3 代理迁移到 Network 结点" class="headerlink" title="将 L3 代理迁移到 Network 结点"></a>将 L3 代理迁移到 Network 结点</h3><ol>
<li>首先在 Controller 上面停掉 L3 代理，在 Network 结点上面启动 L3 代理，其实配置项都是一样的。</li>
<li>然后需要在 Network 结点配置好 Linux 网桥代理，原因不用说，只有 L3 代理不就相当于一个孤点么，没有任何作用。</li>
<li>重新建立一个网络，运行一个实例，配置一个 floating-ip，然后 ssh 进去就可以啦！</li>
</ol>
<h3 id="将 DHCP 代理迁移到 Network 结点"><a href="# 将 DHCP 代理迁移到 Network 结点" class="headerlink" title="将 DHCP 代理迁移到 Network 结点"></a>将 DHCP 代理迁移到 Network 结点</h3><ol>
<li>跟 L3 代理一样，首先还是在 Network 结点中启动 DHCP 代理，然后停掉 Controller 结点上面的 DHCP 代理。</li>
<li>本以为建立好一个网络后，一切还是很正常的运行，但是发现事实不是这样子的。当我写下这篇文章的时候，我只记得我当时去看了实例的 log，发现已经分配了正确的 ip 地址，于是就断定 DHCP 代理是没有错的，并且查询了一下 neutron 的 log，发现有几个是刚刚更新过的，发现在 metadata 的 log 里面，没有将请求或操作连接到正确的消息 url 中，即一直都在请求 127.0.0.1 的本地消息队列，而 Network 结点是没有装消息队列的，所以肯定是不对的。</li>
<li>最后，直接一次性将 metadata 代理也迁移了过去。</li>
<li>建立好一个网络，运行实例，配置一个 floating-ip，然后 ssh 进去就可以啦！</li>
</ol>
<h3 id="结果截个图"><a href="# 结果截个图" class="headerlink" title="结果截个图"></a>结果截个图</h3><ol>
<li><p>Neutron 组件代理列表：<br> <img src="/images/openstack-neutron-agentlist.png" alt=""></p>
<p> 可以看到，Neutron 组件的所有代理目前都跑在了 Network 结点上面。</p>
</li>
<li><p>Floating-ip 测试：</p>
<p> 建立好一个虚拟机实例。<br> <img src="/images/openstack-neutron-novalist.png" alt=""></p>
<p> 然后 ssh 进去访问它。<br> <img src="/images/openstack-neutron-floatingip.png" alt=""></p>
<p> 可以看到我们最后是在 Network 结点上进行访问的，并且需要输入密码，这点我们会在后面详细解释一下。</p>
</li>
</ol>
<h2 id="在 OpenStack 中建立网络"><a href="# 在 OpenStack 中建立网络" class="headerlink" title="在 OpenStack 中建立网络"></a>在 OpenStack 中建立网络 </h2><p> 之前说了那么多，下面具体讲一下在 OpenStack 中如何建立网络，看完这个过程，你会发现里面有一些东西会跟前面的某些名词对应上。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">source admin-openrc.sh</div><div class="line">neutron net-create <span class="keyword">public</span> --shared --<span class="string">provider:</span>physical_network <span class="keyword">public</span> --<span class="string">provider:</span>network_type flat</div></pre></td></tr></table></figure>
<p>这条命令会建立一个类型为 flat，名称为 public 的共享虚拟网络。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">neutron subnet-create public <span class="number">10.0</span><span class="number">.2</span><span class="number">.0</span>/<span class="number">24</span> --name public --allocation-pool start=<span class="number">10.0</span><span class="number">.2</span><span class="number">.110</span>,end=<span class="number">10.0</span><span class="number">.2</span><span class="number">.200</span> --dns-nameserver <span class="number">10.0</span><span class="number">.2</span><span class="number">.3</span> --gateway <span class="number">10.0</span><span class="number">.2</span><span class="number">.2</span></div></pre></td></tr></table></figure>
<p>这条命令会为 public 网络分配 ip 池，可以看到分配了 90 个 ip，并且有相对应的 dns 服务器和网关。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">source demo-openrc.sh</div><div class="line">neutron net-create private</div><div class="line">neutron subnet-create private <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span> --name private --dns-nameserver <span class="number">10.0</span><span class="number">.2</span><span class="number">.3</span> --gateway <span class="number">172.16</span><span class="number">.1</span><span class="number">.1</span></div></pre></td></tr></table></figure>
<p>这两条命令是 demo 用户创建了一个私有的虚拟网络，名字为 private。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">source admin-openrc.sh</div><div class="line">neutron net-<span class="keyword">update</span> <span class="keyword">public</span> <span class="comment">--router:external</span></div><div class="line"><span class="keyword">source</span> demo-openrc.sh</div><div class="line">neutron router-<span class="keyword">create</span> router</div><div class="line">neutron router-<span class="keyword">interface</span>-<span class="keyword">add</span> router <span class="keyword">private</span></div><div class="line">neutron router-gateway-<span class="keyword">set</span> router <span class="keyword">public</span></div></pre></td></tr></table></figure>
<p>上述命令会建立一个路由器 router，并且将 private 网络作为 router 上面的一个网卡，将 public 网络当做 router 上面的网关。建好了网络，在建立实例之前，首先验证一下。在 Controller 结点上面列出端口信息。并且查看每个端口的详细信息。</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="title">source</span> admin-openrc.sh</div><div class="line"><span class="title">neutron</span> router-<span class="keyword">port</span>-list router</div><div class="line">neutron <span class="keyword">port</span>-show $(id)</div></pre></td></tr></table></figure>
<p>截图如下：<br><img src="/images/openstack-router-port-list.png" alt=""></p>
<p>可以看到这些端口绑定的 host_id 是 neutron，即 Network 结点。这是因为 L3 代理是在 Network 结点上面的。这个时候检查一下网络的名空间，就应该在 Network 结点，而不是 Controller 结点了。</p>
<p><img src="/images/openstack-ip-netns.png" alt=""></p>
<p>并且这个 router 的网关 10.0.2.112 只能在 Network 结点上 ping 通。并且，建立好实例后，目前只能在 Network 结点 ping 通分配好的 floating-ip，在 ssh 进去的时候是需要输入密码的，这是因为默认的 ssh-key 是 controller 结点上的。其实，按照官方文档的说法，只要在 public 网络下面的任何结点都是可以通过 ssh 的方式进入虚拟机实例的，而我们目前只能在 Network 结点上，这是因为我们新建的路由器是绑定在 Network 结点上面的，而这是因为 L3 代理是运行在 Network 结点上面的。感觉能够通过添加路由转发规则的方式，令 public 子网内所有的主机都能通过 floating-ip 访问虚拟机实例。这一点会在本文写好之后进行尝试。</p>
<h2 id="总结"><a href="# 总结" class="headerlink" title="总结"></a>总结 </h2><p> 经过这两天的尝试，感觉 OpenStack 的灵活性很高。就像我们这一次把 Neutron 服务从 Controller 结点迁移到 Network 结点，都是直接把网络代理从这边关闭，到那边打开就可以。给我的感觉就像是传说中的那种可以在硬件层面上组装的手机，需要什么零件自己选择。</p>
<p>还有一点就是，在出现错误时，我目前都是看 log 的。log 的目录是在 /var/log/$(service)/*.log 中，每次都查看最近更新过的 log，然后看里面有什么错误之类的。</p>
</div><div class="tags"><a href="/tags/OpenStack/">OpenStack</a><a href="/tags/Neutron/">Neutron</a></div><div class="post-nav"><a href="/2015/12/10/zookeeper-note/" class="pre"><i class="icon-previous">ZooKeeper 学习笔记</i></a><a href="/2015/11/20/openstack_floating_ip/" class="next">OpenStack 平台手动搭建以及 floating-ip 的使用<i class="icon-next"></i></a></div><div data-thread-key="2015/12/02/openstack_neutron/" data-title="OpenStack 平台 Neutron 服务初探" data-url="http://nap-blog.artemisprojects.org/2015/12/02/openstack_neutron/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2015/12/02/openstack_neutron/" data-title="OpenStack 平台 Neutron 服务初探" data-url="http://nap-blog.artemisprojects.org/2015/12/02/openstack_neutron/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search" class="search-form-input"/><input type="hidden" name="sitesearch" value="http://nap-blog.artemisprojects.org"/></form></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/OpenStack/">OpenStack</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/TVDCR/">TVDCR</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/east/">east</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nap/">nap</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/书架/">书架</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/未分类/">未分类</a></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/openstack/" style="font-size: 15px;">openstack</a> <a href="/tags/ORM/" style="font-size: 15px;">ORM</a> <a href="/tags/nosql/" style="font-size: 15px;">nosql</a> <a href="/tags/schema/" style="font-size: 15px;">schema</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/api/" style="font-size: 15px;">api</a> <a href="/tags/east/" style="font-size: 15px;">east</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/Hive/" style="font-size: 15px;">Hive</a> <a href="/tags/Tez/" style="font-size: 15px;">Tez</a> <a href="/tags/devstack/" style="font-size: 15px;">devstack</a> <a href="/tags/transacion/" style="font-size: 15px;">transacion</a> <a href="/tags/dynamic-reconfiguration/" style="font-size: 15px;">dynamic reconfiguration</a> <a href="/tags/nap/" style="font-size: 15px;">nap</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/compose/" style="font-size: 15px;">compose</a> <a href="/tags/OpenStack/" style="font-size: 15px;">OpenStack</a> <a href="/tags/floating-ip/" style="font-size: 15px;">floating-ip</a> <a href="/tags/mesos/" style="font-size: 15px;">mesos</a> <a href="/tags/restful/" style="font-size: 15px;">restful</a> <a href="/tags/Neutron/" style="font-size: 15px;">Neutron</a> <a href="/tags/rest/" style="font-size: 15px;">rest</a></div></div><div class="widget"><div class="widget-title">友情链接</div><ul></ul><a href="http://nap-blog.artemisprojects.org/2015/10/21/books/" title="Bookshelf" target="_blank">Bookshelf</a><ul></ul><a href="http://jetmuffin.github.io/" title="Jie CHEN" target="_blank">Jie CHEN</a><ul></ul><a href="http://cshuo.github.io/" title="Shuo CHEN" target="_blank">Shuo CHEN</a><ul></ul><a href="http://NAP-GHJ.github.io" title="Hongjun GE" target="_blank">Hongjun GE</a><ul></ul><a href="http://itanch.github.io" title="Tianchi LIU" target="_blank">Tianchi LIU</a><ul></ul><a href="http://Luziling.github.io" title="Ziling LU" target="_blank">Ziling LU</a><ul></ul><a href="http://dmemoing.github.io" title="Jing DENG" target="_blank">Jing DENG</a><ul></ul><a href="http://rdmclin2.github.io/" title="Chenglin MENG" target="_blank">Chenglin MENG</a><ul></ul><a href="http://co2y.github.io/" title="Weiyi WANG" target="_blank">Weiyi WANG</a><ul></ul><a href="http://qunnn41.github.io" title="Yiqun WANG" target="_blank">Yiqun WANG</a><ul></ul><a href="http://flyxu.github.io" title="Xiang XU" target="_blank">Xiang XU</a><ul></ul><a href="http://monkey-h.github.io/" title="Zhongliang YUAN" target="_blank">Zhongliang YUAN</a><ul></ul><a href="http://ying-zhang.github.io/" title="Ying ZHANG" target="_blank">Ying ZHANG</a></div></div></div></div><div id="footer">© <a href="/" rel="nofollow">NAP.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script src="/js/jquery.min.js"></script>
<script src="/js/totop.js"></script><script src="/js/fancybox.pack.js"></script>
<script src="/js/jquery.fancybox.js"></script><link rel="stylesheet" href="/css/jquery.fancybox.css"><script>var duoshuoQuery = {short_name:'yingz'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//dn-comment.qbox.me/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script></div></body></html>