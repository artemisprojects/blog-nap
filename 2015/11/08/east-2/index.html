<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description"/><title>HBase ORM 以及 schema 设计 | NAP</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/pure-min.css"/><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"/><link rel="stylesheet" type="text/css" href="/css/style.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">HBase ORM 以及 schema 设计</h1><a id="logo" href="/">NAP</a><p class="description">Next Application Platform</p></div><div id="nav-menu"><a href="/" class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/atom.xml"><i class="icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">HBase ORM 以及 schema 设计</h1><div class="post-meta">2015-11-08 | <span class="categories">分类于<a href="/categories/east/"> east</a></span></div><span data-thread-key="2015/11/08/east-2/" class="ds-thread-count"></span><div class="post-content"><p>近期在做从 oracle 到 HBase 的数据库迁移，接触到了 ORM 以及如何设计 HBase 的 schema，下面把这几天的学习成果记录下来。</p>
<a id="more"></a>
<hr>
<h1 id="schema_u8BBE_u8BA1"><a href="#schema_u8BBE_u8BA1" class="headerlink" title="schema 设计"></a>schema 设计</h1><p>schema 我的理解就是把逻辑上的数据模型和物理上的存储实现结合起来。考虑到 nosql 最大的特点在于横向扩展方便，结合 HBase 按列存储的特点（同一个 column family，CF）存储在同一个 store 中，它的 schema（schema 用词可能不准，因为它是 schemaless 的）设计主要考虑如何扩展方便、如何减少存储 / 查询开销。一般有如下三条设计原则 Denormalization、Duplication 和 Intelligent Keys。</p>
<h2 id="u53CD_u5E8F_u5217_u5316_u548C_u590D_u7528"><a href="#u53CD_u5E8F_u5217_u5316_u548C_u590D_u7528" class="headerlink" title="反序列化和复用"></a>反序列化和复用 </h2><p> 相对于 sql 是把大表细分为小表，再通过 join 操作来合并成大表；nosql 往往是通过数据冗余把小表写大，两个实体共用同一个实现，也就是增加一些字段从而避免 join 问题，因为 nosql 存储廉价。其实 join 实质就是把多张小表合并成一张大表，对应 mongo 就是嵌套，对应 HBase/cassandra 就是把小表用更多的字段写大然后用 row key 连接起来。当数据量大的时候不 join 比 join 好是指合并的代价大于存储的代价，所以 nosql 通过反序列化刚好不用 join 才得以体现优势。hbasecon2012 上有一篇 HBase Schema Design（<a href="http://www.slideshare.net/cloudera/5-h-base-schemahbasecon2012" target="_blank" rel="external">how i learned to stop worrying and love denormalization</a>）详细介绍了 denormalization。</p>
<h2 id="rowkey_u8BBE_u8BA1"><a href="#rowkey_u8BBE_u8BA1" class="headerlink" title="rowkey 设计"></a>rowkey 设计 </h2><p> 因为 HBase 中数据是根据 rowkey 索引的，相近的 rowkey（默认是字典序）在同一个 regionserver 上，rowkey 设计主要考虑把同时使用的数据存放在一起，减少查询开销，这是根据业务需求定的。比如利用时间戳做 rowkey 的一部分（把 MAX_VALUE-timestamp 加到 rowkey 的最后）可以查询到最近使用的，再比如如下这个例子把关系型数据库中的两张表的主键合在一起。</p>
<p>一个订单例子的转变如下：<br><img src="/images/rdbms-1.png" alt=""><br><img src="/images/hbase-1.png"alt=""></p>
<p>从上面这个例子可以看出，在 rdbms 中，通常是通过 service order table 根据 customer 和 product 来 left join 这两张表进行查询；而在 HBase 中，对于 service order 这张表如果查询 customer 就没必要做 join 了，之前通过外键索引到 customer 信息，在这里已经保存在 service order 里了。这虽然会带来额外的存储，但在 nosql 中这是很正常的操作方式。<br>此外，这个 rowkey 的设计既能找到对应的 product 和 customer，并且把所有 A 开头的商品保存在了一起，如果查询经常是某一类商品一起查询的话，那这种设计方式就很合理。</p>
<h2 id="u8F6C_u6362_u4F8B_u5B50"><a href="#u8F6C_u6362_u4F8B_u5B50" class="headerlink" title="转换例子"></a>转换例子 </h2><p> 一般来说 HBase schema 的设计主要考虑这三点，再看两个根据这三条原则对应到数据转换例子。</p>
<h3 id="u4E00_u5BF9_u591A"><a href="#u4E00_u5BF9_u591A" class="headerlink" title="一对多"></a>一对多</h3><p><img src="/images/rdbms-2.png" alt=""><br><img src="/images/hbase-2.png"alt=""></p>
<h3 id="u591A_u5BF9_u591A"><a href="#u591A_u5BF9_u591A" class="headerlink" title="多对多"></a>多对多</h3><p><img src="/images/rdbms-3.png" alt=""><br><img src="/images/hbase-3.png"alt=""></p>
<p>第二个多对多的例子就是把两个一对多结合起来，没有借助一张中间表，这是因为 HBase 的 CF 是可以随意添加 column 的，很灵活，所以刚好可以这么做。</p>
<h1 id="u5173_u4E8E_u770B_u7684_u4E24_u7BC7_u8BBA_u6587"><a href="#u5173_u4E8E_u770B_u7684_u4E24_u7BC7_u8BBA_u6587" class="headerlink" title="关于看的两篇论文"></a>关于看的两篇论文 </h1><p> 我感觉这两篇论文侧重于两个方向，这在最后的问题中会说明，然后基本也是 guide。<br>论文 MySQL to NoSQL Data Modeling Challenges in Supporting Scalability 主要写了如何迁移 tweet（重点在第 6 段），主要也是 schema 变化的描述，基本思想就是上面三点。<br>另一篇 ONDM: an Object-NoSQL Datastore Mapper 介绍了一个 ORM 映射框架 ORM，现在 ORM 框架已经很多了，这个和现在的也差不多，下面介绍一下 ORM。</p>
<h1 id="ORM"><a href="#ORM" class="headerlink" title="ORM"></a>ORM</h1><p>ORM(Object Relational Mapping)通常是指对象和关系型数据的映射，对应在 nosql 中也叫 ODM(D:data)，OGM(G:grid）。这个东西可以让程序员不用关心数据库的设计，而只用关系对象之间的关系。我主要是了解了一些针对 nosql 的 ORM 框架，比如 hibernate ogm，kundera，datanucleus。</p>
<p>从上层来看他们大都是一样的，都是把对象（java 中的 class）通过注解的方式映射到 nosql 中，最简单的数据模型包括实体、属性和关系。比如这样：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@PersistenceCapable</span> </span><br><span class="line"><span class="variable">@Extensions</span>(&#123;</span><br><span class="line">    <span class="variable">@Extension</span>(vendorName = <span class="string">"datanucleus"</span>, key = <span class="string">"hbase.columnFamily.meta.bloomFilter"</span>, value = <span class="string">"ROWKEY"</span>), </span><br><span class="line">    <span class="variable">@Extension</span>(vendorName = <span class="string">"datanucleus"</span>, key = <span class="string">"hbase.columnFamily.meta.inMemory"</span>, value = <span class="string">"true"</span>) </span><br><span class="line">&#125;) </span><br><span class="line">public class MyClass</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">@PrimaryKey</span> </span><br><span class="line">    private long id; </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// column family data, name of attribute blob </span></span><br><span class="line">    <span class="variable">@Column</span>(name = <span class="string">"data:blob"</span>) </span><br><span class="line">    private String blob; </span><br><span class="line"></span><br><span class="line">    <span class="comment">// column family meta, name of attribute firstName </span></span><br><span class="line">    <span class="variable">@Column</span>(name = <span class="string">"meta:firstName"</span>) </span><br><span class="line">    private String firstName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// column family meta, name of attribute firstName </span></span><br><span class="line">    <span class="variable">@Column</span>(name = <span class="string">"meta:lastName"</span>) </span><br><span class="line">    private String lastName;</span><br><span class="line">   	</span><br><span class="line">   	<span class="attr_selector">[... getter and setter ...]</span></span><br></pre></td></tr></table></figure></p>
<p>这些 @符号就把该类中的属性映射到 HBase 中了，至于数据库连接和 class 与 CF 的映射通常是通过 xml 文件来描述。</p>
<h1 id="u601D_u8003"><a href="#u601D_u8003" class="headerlink" title="思考"></a>思考 </h1><p>1、根据先有对象的逻辑，再设计 HBase，其实考虑的就是业务需求，把哪些字段放在一起，rowkey 怎么设计，哪些需要 join 合并起来等等。<br>2、迁移数据的话肯定是设计好 schema 然后抽数据(不会通过两次 ORM 来迁移)，ORM 只是说在开发过程中层次分离，偏向于数据库开发，而不是数据库迁移。<br> 所以感觉这两个不是同一个东西 = =||</p>
</div><div class="tags"><a href="/tags/ORM/">ORM</a><a href="/tags/nosql/">nosql</a><a href="/tags/schema/">schema</a></div><div class="post-nav"><a href="/2015/11/09/nap-restapi/" class="pre"><i class="icon-previous">Restful Api for NAP</i></a><a href="/2015/11/07/nap-compose-2/" class="next">跨主机的 docker 容器编排 nap-compose （二）<i class="icon-next"></i></a></div><div data-thread-key="2015/11/08/east-2/" data-title="HBase ORM 以及 schema 设计" data-url="http://nap-blog.artemisprojects.org/2015/11/08/east-2/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2015/11/08/east-2/" data-title="HBase ORM 以及 schema 设计" data-url="http://nap-blog.artemisprojects.org/2015/11/08/east-2/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search" class="search-form-input"/><input type="hidden" name="sitesearch" value="http://nap-blog.artemisprojects.org"/></form></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/OpenStack/">OpenStack</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/TVDCR/">TVDCR</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/east/">east</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nap/">nap</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/未分类/">未分类</a></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/mesos/" style="font-size: 15px;">mesos</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/dynamic-reconfiguration/" style="font-size: 15px;">dynamic reconfiguration</a> <a href="/tags/restful/" style="font-size: 15px;">restful</a> <a href="/tags/rest/" style="font-size: 15px;">rest</a> <a href="/tags/OpenStack/" style="font-size: 15px;">OpenStack</a> <a href="/tags/Neutron/" style="font-size: 15px;">Neutron</a> <a href="/tags/floating-ip/" style="font-size: 15px;">floating-ip</a> <a href="/tags/nap/" style="font-size: 15px;">nap</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/compose/" style="font-size: 15px;">compose</a> <a href="/tags/transacion/" style="font-size: 15px;">transacion</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/Hive/" style="font-size: 15px;">Hive</a> <a href="/tags/Tez/" style="font-size: 15px;">Tez</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/api/" style="font-size: 15px;">api</a> <a href="/tags/ORM/" style="font-size: 15px;">ORM</a> <a href="/tags/nosql/" style="font-size: 15px;">nosql</a> <a href="/tags/schema/" style="font-size: 15px;">schema</a> <a href="/tags/east/" style="font-size: 15px;">east</a> <a href="/tags/openstack/" style="font-size: 15px;">openstack</a> <a href="/tags/devstack/" style="font-size: 15px;">devstack</a></div></div><div class="widget"><div class="widget-title">友情链接</div><ul></ul><a href="http://artemisprojects.org/" title="Artemis Projects" target="_blank">Artemis Projects</a><ul></ul><a href="http://www.nju.edu.cn/" title="Nanjing U." target="_blank">Nanjing U.</a><ul></ul><a href="http://chun.nemoworks.info/" title="Chun CAO" target="_blank">Chun CAO</a><ul></ul><a href="http://chrisforest.github.io/" title="Chenchen CAO" target="_blank">Chenchen CAO</a><ul></ul><a href="http://jetmuffin.github.io/" title="Jie CHEN" target="_blank">Jie CHEN</a><ul></ul><a href="http://cshuo.github.io/" title="Shuo CHEN" target="_blank">Shuo CHEN</a><ul></ul><a href="http://itanch.github.io" title="Tianchi LIU" target="_blank">Tianchi LIU</a><ul></ul><a href="http://rdmclin2.github.io/" title="Chenglin MENG" target="_blank">Chenglin MENG</a><ul></ul><a href="http://monkey-h.github.io/" title="Zhongliang YUAN" target="_blank">Zhongliang YUAN</a><ul></ul><a href="http://ying-zhang.github.io/" title="Ying ZHANG" target="_blank">Ying ZHANG</a></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/03/15/hadoop_hive_tez/">Hadoop, Hive, Tez 搭建笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/nap-doc/">NAP 使用手册</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/30/photos/">我们的 2015</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/18/hotSwapAgent-not/">Hotswap Agent 学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/10/zookeeper-note/">ZooKeeper 学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/02/openstack_neutron/">OpenStack 平台 Neutron 服务初探</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/20/openstack_floating_ip/">OpenStack 平台手动搭建以及 floating-ip 的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/19/fcws-api-doc/">凤城卫士 API 文档</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/10/spring-transaction-manager/">Spring Transaction Manager 学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/09/devstack-1/">OpenStack 与 DevStack 初探</a></li></ul></div><div class="widget"><div class="comments-title">最近评论</div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div></div></div></div><div id="footer">© <a href="/" rel="nofollow">NAP.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/totop.js" type="text/javascript"></script><script src="/js/fancybox.pack.js" type="text/javascript"></script>
<script src="/js/jquery.fancybox.js" type="text/javascript"></script><link rel="stylesheet" href="/css/jquery.fancybox.css" type="text/css"><script>var duoshuoQuery = {short_name:'yingz'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//dn-comment.qbox.me/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script></div></body></html>