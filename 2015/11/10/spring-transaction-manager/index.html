<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description"/><title>Spring Transaction Manager 学习笔记 | NAP</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/pure-min.css"/><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"/><link rel="stylesheet" type="text/css" href="/css/style.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Spring Transaction Manager 学习笔记</h1><a id="logo" href="/">NAP</a><p class="description">Next Application Platform</p></div><div id="nav-menu"><a href="/" class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/atom.xml"><i class="icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">Spring Transaction Manager 学习笔记</h1><div class="post-meta">2015-11-10 | <span class="categories">分类于<a href="/categories/TVDCR/"> TVDCR</a></span></div><span data-thread-key="2015/11/10/spring-transaction-manager/" class="ds-thread-count"></span><div class="post-content"><p>使用 Spring 声明式事务处理，是通过结合 IoC 容器和 Spring 已有的 TransactionProxyFactoryBean 来对事务管理进行配置。<br>在 TransactionProxyFactoryBean 中为事务方法配置传播行为、并发事务隔离级别这些事务处理的属性，<br>从而对声明式事务的处理提供指导。<br>声明式事务处理的实现，大致可以分为以下三个部分：</p>
<ul>
<li>读取和处理在 IoC 容器中配置的事务处理属性， 并转为 Spring 事务处理需要的内部数据结构。</li>
<li>Spring 事务处理模块实现的统一的事务处理过程。包含了处理事务配置属性，以及与现场绑定完成事务处理。Spring 通过 TransactionInfo 和 TransactionStatus 两个数据对象，在事务处理过程中记录和传递相关执行场景。</li>
<li>对于底层的事务操作，Spring 委托给具体的事务处理器来完成，即 PlatformTransactionManager 的具体实现。比如 DataSourceTransactionManager 和 HibernateTransactionManager。</li>
</ul>
<a id="more"></a>
<hr>
<h2 id="u58F0_u660E_u5F0F_u4E8B_u52A1_u5904_u7406_u7684_u57FA_u672C_u8FC7_u7A0B"><a href="#u58F0_u660E_u5F0F_u4E8B_u52A1_u5904_u7406_u7684_u57FA_u672C_u8FC7_u7A0B" class="headerlink" title="声明式事务处理的基本过程"></a>声明式事务处理的基本过程 </h2><p> 使用 Spring 声明式事务处理，是通过结合 IoC 容器和 Spring 已有的 TransactionProxyFactoryBean 来对事务管理进行配置。<br>在 TransactionProxyFactoryBean 中为事务方法配置传播行为、并发事务隔离级别这些事务处理的属性，<br>从而对声明式事务的处理提供指导。<br>声明式事务处理的实现，大致可以分为以下三个部分：</p>
<ul>
<li>读取和处理在 IoC 容器中配置的事务处理属性， 并转为 Spring 事务处理需要的内部数据结构。</li>
<li>Spring 事务处理模块实现的统一的事务处理过程。包含了处理事务配置属性，以及与现场绑定完成事务处理。Spring 通过 TransactionInfo 和 TransactionStatus 两个数据对象，在事务处理过程中记录和传递相关执行场景。</li>
<li>对于底层的事务操作，Spring 委托给具体的事务处理器来完成，即 PlatformTransactionManager 的具体实现。比如 DataSourceTransactionManager 和 HibernateTransactionManager。</li>
</ul>
<h2 id="u4E8B_u52A1_u5904_u7406_u62E6_u622A_u5668_u7684_u914D_u7F6E"><a href="#u4E8B_u52A1_u5904_u7406_u62E6_u622A_u5668_u7684_u914D_u7F6E" class="headerlink" title="事务处理拦截器的配置"></a>事务处理拦截器的配置 </h2><p> 配置工作，包括设置拦截器 TransactionInterceptor、通知器 DefaultPointcutAdvisor、<br>注入进来的 PlatformTransactionManager 和事务处理属性 TransactionAttribute。<br>这些工作是由 IoC 的 TransactionProxyFactoryBean 完成的。它的实现如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">TransactionProxyFactoryBean</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AbstractSingletonProxyFactoryBean</span></span><br><span class="line"></span>		implements <span class="type">BeanFactoryAware</span> &#123;</span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * 这个拦截器通过 AOP 发挥作用，通过这个拦截器，Spring 封装了事务处理实现</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="type">TransactionInterceptor</span> transactionInterceptor = <span class="keyword">new</span> <span class="type">TransactionInterceptor</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">Pointcut</span> pointcut;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Set the default transaction manager. This will perform actual</span><br><span class="line">	 * transaction management: This class is just a way of invoking it.</span><br><span class="line">	 * @see TransactionInterceptor#setTransactionManager</span><br><span class="line">	 */</span></span><br><span class="line">	public void setTransactionManager(<span class="type">PlatformTransactionManager</span> transactionManager) &#123;</span><br><span class="line">		<span class="keyword">this</span>.transactionInterceptor.setTransactionManager(transactionManager);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Creates an advisor for this FactoryBean's TransactionInterceptor.</span><br><span class="line">	 * 创建 Spring AOP 对事务处理的 AOP</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="type">Object</span> createMainInterceptor() &#123;</span><br><span class="line">		<span class="keyword">this</span>.transactionInterceptor.afterPropertiesSet();</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.pointcut != <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="type">DefaultPointcutAdvisor</span>(<span class="keyword">this</span>.pointcut, <span class="keyword">this</span>.transactionInterceptor);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// Rely on default pointcut.</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="type">TransactionAttributeSourceAdvisor</span>(<span class="keyword">this</span>.transactionInterceptor);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有上面的代码可以知道，TransactionInterceptor 在方法 <code>createMainInterceptor</code> 中被配置为 Advisor 通知器的一部分。<br>而 <code>createMainInterceptor</code> 方法在 IoC 容器完成 Bean 的注入依赖时，通过 <code>initiaizeBean</code> 方法被调用，调用过程如下图:<br><img src="/images/createMainInterceptor.png" alt=""></p>
<p>这个 <code>afterPropertiesSet</code> 方法的功能实现如下所示。从代码中可以看到，在建立 TransactionProxyFactoryBean 的事务 <br> 处理拦截器的时候，首先需要对 ProxyFactoryBean 的目标 Bean 设置进行检查，如果这个目标 Bean 的配置是正确的，<br>就会通过创建一个 ProxyFactory 对象，从而实现 AOP 的使用。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.<span class="keyword">target</span> == <span class="keyword">null</span>) &#123;</span><br><span class="line">    	<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Property'target'is required"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.<span class="keyword">target</span> <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">    	<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"'target' needs to be a bean reference, not a bean name as value"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.proxyClassLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">    	<span class="keyword">this</span>.proxyClassLoader = ClassUtils.getDefaultClassLoader();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//TransactionFactoryBean 使用 ProxyFactory 完成 AOP 的基本功能</span></span><br><span class="line">    ProxyFactory proxyFactory = <span class="keyword">new</span> ProxyFactory();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.preInterceptors != <span class="keyword">null</span>) &#123;</span><br><span class="line">    	<span class="keyword">for</span> (Object interceptor : <span class="keyword">this</span>.preInterceptors) &#123;</span><br><span class="line">    		proxyFactory.addAdvisor(<span class="keyword">this</span>.advisorAdapterRegistry.wrap(interceptor));</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Add the main interceptor (typically an Advisor).</span></span><br><span class="line">    proxyFactory.addAdvisor(<span class="keyword">this</span>.advisorAdapterRegistry.wrap(createMainInterceptor()));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.postInterceptors != <span class="keyword">null</span>) &#123;</span><br><span class="line">    	<span class="keyword">for</span> (Object interceptor : <span class="keyword">this</span>.postInterceptors) &#123;</span><br><span class="line">    		proxyFactory.addAdvisor(<span class="keyword">this</span>.advisorAdapterRegistry.wrap(interceptor));</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    proxyFactory.copyFrom(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// 设置目标源</span></span><br><span class="line">    TargetSource targetSource = createTargetSource(<span class="keyword">this</span>.<span class="keyword">target</span>);</span><br><span class="line">    proxyFactory.setTargetSource(targetSource);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.proxyInterfaces != <span class="keyword">null</span>) &#123;</span><br><span class="line">    	proxyFactory.setInterfaces(<span class="keyword">this</span>.proxyInterfaces);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!isProxyTargetClass()) &#123;</span><br><span class="line">    	<span class="comment">// Rely on AOP infrastructure to tell us what interfaces to proxy.</span></span><br><span class="line">    	proxyFactory.setInterfaces(</span><br><span class="line">    			ClassUtils.getAllInterfacesForClass(targetSource.getTargetClass(), <span class="keyword">this</span>.proxyClassLoader));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">this</span>.proxy = proxyFactory.getProxy(<span class="keyword">this</span>.proxyClassLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="u4E8B_u52A1_u5904_u7406_u62E6_u622A_u5668_u7684_u5B9E_u73B0"><a href="#u4E8B_u52A1_u5904_u7406_u62E6_u622A_u5668_u7684_u5B9E_u73B0" class="headerlink" title="事务处理拦截器的实现"></a>事务处理拦截器的实现 </h2><p> 对事务方法的拦截是通过 <code>invoke</code> 方法，它使 Proxy 代理对象的回调方法。在事务处理拦截器 TransactionInterceptor 中，<br><code>invoke</code>方法的实现代码如下。可以看到，首先获得调用方法的事务处理配置，之后取得配置的 PlatformTransactionManager<br>, 由这个事务处理器来实现事务的创建、提交、回滚操作。</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">public <span class="type">Object</span> invoke(final <span class="type">MethodInvocation</span> invocation) throws <span class="type">Throwable</span> &#123;</span><br><span class="line">	// <span class="type">Work</span> <span class="keyword">out</span> the target class: may be &#123;@code null&#125;.</span><br><span class="line">	// <span class="type">The</span> <span class="type">TransactionAttributeSource</span> should be passed the target class</span><br><span class="line">	// <span class="keyword">as</span> well <span class="keyword">as</span> the <span class="keyword">method</span>, which may be <span class="keyword">from</span> an <span class="keyword">interface</span>.</span><br><span class="line">	<span class="type">Class</span>&lt;?&gt; targetClass = (invocation.getThis() != null ? <span class="type">AopUtils</span>.getTargetClass(invocation.getThis()) : null);</span><br><span class="line"></span><br><span class="line">	// <span class="type">Adapt</span> to <span class="type">TransactionAspectSupport</span>'s invokeWithinTransaction...</span><br><span class="line">	<span class="keyword">return</span> invokeWithinTransaction(invocation.getMethod(), targetClass, new <span class="type">InvocationCallback</span>() &#123;</span><br><span class="line">		@<span class="type">Override</span></span><br><span class="line">		public <span class="type">Object</span> proceedWithInvocation() throws <span class="type">Throwable</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> invocation.proceed();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">protected <span class="type">Object</span> invokeWithinTransaction(<span class="type">Method</span> <span class="keyword">method</span>, <span class="type">Class</span>&lt;?&gt; targetClass, final <span class="type">InvocationCallback</span> invocation)</span><br><span class="line">		throws <span class="type">Throwable</span> &#123;</span><br><span class="line"></span><br><span class="line">	// <span class="type">If</span> the transaction attribute <span class="keyword">is</span> null, the <span class="keyword">method</span> <span class="keyword">is</span> non-transactional.</span><br><span class="line">	final <span class="type">TransactionAttribute</span> txAttr = getTransactionAttributeSource().getTransactionAttribute(<span class="keyword">method</span>, targetClass);</span><br><span class="line">	final <span class="type">PlatformTransactionManager</span> tm = determineTransactionManager(txAttr);</span><br><span class="line">	final <span class="type">String</span> joinpointIdentification = methodIdentification(<span class="keyword">method</span>, targetClass);</span><br><span class="line">	/**</span><br><span class="line">	 * 区分不同类型的 <span class="type">PlatformTransactionManager</span>, 因为他们的调用方式不同，</span><br><span class="line">	 * 像<span class="type">DataSourceTransactionManager</span> 来说，不是 <span class="type">CallbackPreferringPlatformTransactionManager</span>,</span><br><span class="line">	 * 不需要通过回调的方式来使用。</span><br><span class="line">	 */</span><br><span class="line">	<span class="keyword">if</span> (txAttr == null || !(tm instanceof <span class="type">CallbackPreferringPlatformTransactionManager</span>)) &#123;</span><br><span class="line">		// <span class="type">Standard</span> transaction demarcation <span class="keyword">with</span> getTransaction <span class="keyword">and</span> commit/rollback calls.</span><br><span class="line">		//<span class="type">TransactionInfo</span> 是保存当前事务状态的对象</span><br><span class="line">		<span class="type">TransactionInfo</span> txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification);</span><br><span class="line">		<span class="type">Object</span> retVal = null;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			// <span class="type">This</span> <span class="keyword">is</span> an around advice: <span class="type">Invoke</span> the next interceptor <span class="keyword">in</span> the chain.</span><br><span class="line">			// <span class="type">This</span> will normally <span class="literal">result</span> <span class="keyword">in</span> a target <span class="keyword">object</span> being invoked.</span><br><span class="line">			retVal = invocation.proceedWithInvocation();</span><br><span class="line">		&#125;</span><br><span class="line">		catch (<span class="type">Throwable</span> ex) &#123;</span><br><span class="line">			// target invocation exception</span><br><span class="line">			completeTransactionAfterThrowing(txInfo, ex);</span><br><span class="line">			throw ex;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			cleanupTransactionInfo(txInfo);</span><br><span class="line">		&#125;</span><br><span class="line">		commitTransactionAfterReturning(txInfo);</span><br><span class="line">		<span class="keyword">return</span> retVal;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		.....</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>## 事务的创建 <br> 我们注意到 TransactionInterceptor 拦截器的 <code>invoke</code> 回调中使用的 <code>createTransactionIfNecessary</code> 方法，它是事务创建的起点。它的实现代码如下。在 <code>createTransactionIfNecessary</code> 方法调用中，可以看到两个重要的数据对象 TransactionStatus 和 TransactionInfo 的调用，这两个对象持有的 <br> 数据是事务处理器对事务进行处理的主要依据，对他们的使用贯穿着整个事务处理的过程。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function">TransactionInfo <span class="title">createTransactionIfNecessary</span><span class="params">(</span><br><span class="line">		PlatformTransactionManager tm, TransactionAttribute txAttr, <span class="keyword">final</span> String joinpointIdentification)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If no name specified, apply method identification as transaction name.</span></span><br><span class="line">	<span class="keyword">if</span> (txAttr != <span class="keyword">null</span> &amp;&amp; txAttr.getName() == <span class="keyword">null</span>) &#123;</span><br><span class="line">		txAttr = <span class="keyword">new</span> DelegatingTransactionAttribute(txAttr) &#123;</span><br><span class="line">			<span class="annotation">@Override</span></span><br><span class="line">			<span class="keyword">public</span> <span class="function">String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="keyword">return</span> joinpointIdentification;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	TransactionStatus status = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">if</span> (txAttr != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (tm != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">/**</span><br><span class="line">			 * 这里使用我们定义好的事务方法的配置信息。</span><br><span class="line">			 * 事务创建由事务处理器来完成，同时返回 TransactionStatus 来记录</span><br><span class="line">			 * 当前的事务状态，包括已经创建的事务。</span><br><span class="line">			 */</span></span><br><span class="line">			status = tm.getTransaction(txAttr);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">				logger.debug(<span class="string">"Skipping transactional joinpoint ["</span> + joinpointIdentification +</span><br><span class="line">						<span class="string">"] because no transaction manager has been configured"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 准备 TransactionInfo，它封装了事务处理的配置信息以及 TransactionStatus</span></span><br><span class="line">	<span class="function"><span class="keyword">return</span> <span class="title">prepareTransactionInfo</span><span class="params">(tm, txAttr, joinpointIdentification, status)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function">TransactionInfo <span class="title">prepareTransactionInfo</span><span class="params">(PlatformTransactionManager tm,</span><br><span class="line">		TransactionAttribute txAttr, String joinpointIdentification, TransactionStatus status)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	TransactionInfo txInfo = <span class="keyword">new</span> TransactionInfo(tm, txAttr, joinpointIdentification);</span><br><span class="line">	<span class="keyword">if</span> (txAttr != <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">// We need a transaction for this method</span></span><br><span class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(<span class="string">"Getting transaction for ["</span> + txInfo.getJoinpointIdentification() + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// The transaction manager will flag an error if an incompatible tx already exists</span></span><br><span class="line">		txInfo.newTransactionStatus(status);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// The TransactionInfo.hasTransaction() method will return</span></span><br><span class="line">		<span class="comment">// false. We created it only to preserve the integrity of</span></span><br><span class="line">		<span class="comment">// the ThreadLocal stack maintained in this class.</span></span><br><span class="line">		<span class="keyword">if</span> (logger.isTraceEnabled())</span><br><span class="line">			logger.trace(<span class="string">"Don't need to create transaction for ["</span> + joinpointIdentification +</span><br><span class="line">					<span class="string">"]: This method isn't transactional."</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// We always bind the TransactionInfo to the thread, even if we didn't create</span></span><br><span class="line">	<span class="comment">// a new transaction here. This guarantees that the TransactionInfo stack</span></span><br><span class="line">	<span class="comment">// will be managed correctly even if no transaction was created by this aspect.</span></span><br><span class="line">	txInfo.bindToThread();</span><br><span class="line">	<span class="keyword">return</span> txInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在以上的处理过程完成以后，可以看到具体的事务创建就交给事务处理器来完成了。下面看事务处理器中去了解 <br> 一下更底层的事务创建过程，它被上述代码的 <code>tm.getTransaction(txAttr)</code> 调用出发，生成一个 TransactionStatus 对象，<br>封装了底层事务对象的创建。在 AbstractPlatformTransactionManager 中，提供了创建事务的模板，代码如下所示。<br>AbstractPlatformTransactionManager 会根据事务属性配置和当前线程绑定的事务信息，对事务是否需要创建、怎样创建 <br> 进行一些通用的处理，然后把事务创建的底层工作交给具体的事务处理器完成(如 DataSourceTransactionManagera)。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="function">TransactionStatus <span class="title">getTransaction</span><span class="params">(TransactionDefinition definition)</span> <span class="keyword">throws</span> TransactionException </span>&#123;</span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * 这个 doGetTransaction 是抽象函数，Transaction 对象的取得由具体的事务处理器实现。</span><br><span class="line">	 * 比如 DataSourceTransactionManager</span><br><span class="line">	 */</span></span><br><span class="line">	Object transaction = doGetTransaction();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Cache debug flag to avoid repeated checks.</span></span><br><span class="line">	<span class="keyword">boolean</span> debugEnabled = logger.isDebugEnabled();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (definition == <span class="keyword">null</span>) &#123;</span><br><span class="line">		<span class="comment">/*</span><br><span class="line">		 * 使用默认的 DefaultTransactionDefinition：</span><br><span class="line">		 * propagationBehavior=PROPAGATION_REQUIRED</span><br><span class="line">		 * isolationLevel=ISOLATION_DEFAULT;</span><br><span class="line">		 * timeout=TIMEOUT_DEFAULT;</span><br><span class="line">		 * readOnly=false;</span><br><span class="line">		 */</span></span><br><span class="line">		<span class="comment">// Use defaults if no transaction definition given.</span></span><br><span class="line">		definition = <span class="keyword">new</span> DefaultTransactionDefinition();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 如果当前线程存在事务，需要根据事务传播属性生成事务</span></span><br><span class="line">	<span class="keyword">if</span> (isExistingTransaction(transaction)) &#123;</span><br><span class="line">		<span class="comment">// Existing transaction found -&gt; check propagation behavior to find out how to behave.</span></span><br><span class="line">		<span class="function"><span class="keyword">return</span> <span class="title">handleExistingTransaction</span><span class="params">(definition, transaction, debugEnabled)</span></span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Check definition settings for new transaction.</span></span><br><span class="line">	<span class="keyword">if</span> (definition.getTimeout() &lt; TransactionDefinition.TIMEOUT_DEFAULT) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> InvalidTimeoutException(<span class="string">"Invalid transaction timeout"</span>, definition.getTimeout());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// No existing transaction found -&gt; check propagation behavior to find out how to proceed.</span></span><br><span class="line">	<span class="keyword">if</span> (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalTransactionStateException(</span><br><span class="line">				<span class="string">"No existing transaction found for transaction marked with propagation'mandatory'"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED ||</span><br><span class="line">			definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW ||</span><br><span class="line">			definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123;</span><br><span class="line">		SuspendedResourcesHolder suspendedResources = suspend(<span class="keyword">null</span>);</span><br><span class="line">		<span class="keyword">if</span> (debugEnabled) &#123;</span><br><span class="line">			logger.debug(<span class="string">"Creating new transaction with name ["</span> + definition.getName() + <span class="string">"]: "</span> + definition);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">boolean</span> newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</span><br><span class="line">			DefaultTransactionStatus status = newTransactionStatus(</span><br><span class="line">					definition, transaction, <span class="keyword">true</span>, newSynchronization, debugEnabled, suspendedResources);</span><br><span class="line">			<span class="comment">/*</span><br><span class="line">			 * 这里是创建事务的调用，由具体的事务处理器完成，比如：</span><br><span class="line">			 * HibernateTransactionManager 和 DataSourceTransactionManager</span><br><span class="line">			 */</span></span><br><span class="line">			doBegin(transaction, definition);</span><br><span class="line">			prepareSynchronization(status, definition);</span><br><span class="line">			<span class="keyword">return</span> status;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">			resume(<span class="keyword">null</span>, suspendedResources);</span><br><span class="line">			<span class="keyword">throw</span> ex;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Error err) &#123;</span><br><span class="line">			resume(<span class="keyword">null</span>, suspendedResources);</span><br><span class="line">			<span class="keyword">throw</span> err;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// Create"empty"transaction: no actual transaction, but potentially synchronization.</span></span><br><span class="line">		<span class="keyword">if</span> (definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT &amp;&amp; logger.isWarnEnabled()) &#123;</span><br><span class="line">			logger.warn(<span class="string">"Custom isolation level specified but no actual transaction initiated; "</span> +</span><br><span class="line">					<span class="string">"isolation level will effectively be ignored: "</span> + definition);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">boolean</span> newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);</span><br><span class="line">		<span class="function"><span class="keyword">return</span> <span class="title">prepareTransactionStatus</span><span class="params">(definition, <span class="keyword">null</span>, <span class="keyword">true</span>, newSynchronization, debugEnabled, <span class="keyword">null</span>)</span></span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Create a TransactionStatus for an existing transaction.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function">TransactionStatus <span class="title">handleExistingTransaction</span><span class="params">(</span><br><span class="line">		TransactionDefinition definition, Object transaction, <span class="keyword">boolean</span> debugEnabled)</span></span><br><span class="line">		<span class="keyword">throws</span> TransactionException </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NEVER) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalTransactionStateException(</span><br><span class="line">				<span class="string">"Existing transaction found for transaction marked with propagation 'never'"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NOT_SUPPORTED) &#123;</span><br><span class="line">		<span class="keyword">if</span> (debugEnabled) &#123;</span><br><span class="line">			logger.debug(<span class="string">"Suspending current transaction"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		Object suspendedResources = suspend(transaction);</span><br><span class="line">		<span class="keyword">boolean</span> newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);</span><br><span class="line">		<span class="function"><span class="keyword">return</span> <span class="title">prepareTransactionStatus</span><span class="params">(</span><br><span class="line">				definition, <span class="keyword">null</span>, <span class="keyword">false</span>, newSynchronization, debugEnabled, suspendedResources)</span></span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW) &#123;</span><br><span class="line">		<span class="keyword">if</span> (debugEnabled) &#123;</span><br><span class="line">			logger.debug(<span class="string">"Suspending current transaction, creating new transaction with name ["</span> +</span><br><span class="line">					definition.getName() + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		SuspendedResourcesHolder suspendedResources = suspend(transaction);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">boolean</span> newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</span><br><span class="line">			DefaultTransactionStatus status = newTransactionStatus(</span><br><span class="line">					definition, transaction, <span class="keyword">true</span>, newSynchronization, debugEnabled, suspendedResources);</span><br><span class="line">			doBegin(transaction, definition);</span><br><span class="line">			prepareSynchronization(status, definition);</span><br><span class="line">			<span class="keyword">return</span> status;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (RuntimeException beginEx) &#123;</span><br><span class="line">			resumeAfterBeginException(transaction, suspendedResources, beginEx);</span><br><span class="line">			<span class="keyword">throw</span> beginEx;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Error beginErr) &#123;</span><br><span class="line">			resumeAfterBeginException(transaction, suspendedResources, beginErr);</span><br><span class="line">			<span class="keyword">throw</span> beginErr;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!isNestedTransactionAllowed()) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> NestedTransactionNotSupportedException(</span><br><span class="line">					<span class="string">"Transaction manager does not allow nested transactions by default -"</span> +</span><br><span class="line">					<span class="string">"specify'nestedTransactionAllowed'property with value'true'"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (debugEnabled) &#123;</span><br><span class="line">			logger.debug(<span class="string">"Creating nested transaction with name ["</span> + definition.getName() + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (useSavepointForNestedTransaction()) &#123;</span><br><span class="line">			<span class="comment">// Create savepoint within existing Spring-managed transaction,</span></span><br><span class="line">			<span class="comment">// through the SavepointManager API implemented by TransactionStatus.</span></span><br><span class="line">			<span class="comment">// Usually uses JDBC 3.0 savepoints. Never activates Spring synchronization.</span></span><br><span class="line">			DefaultTransactionStatus status =</span><br><span class="line">					prepareTransactionStatus(definition, transaction, <span class="keyword">false</span>, <span class="keyword">false</span>, debugEnabled, <span class="keyword">null</span>);</span><br><span class="line">			status.createAndHoldSavepoint();</span><br><span class="line">			<span class="keyword">return</span> status;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// Nested transaction through nested begin and commit/rollback calls.</span></span><br><span class="line">			<span class="comment">// Usually only for JTA: Spring synchronization might get activated here</span></span><br><span class="line">			<span class="comment">// in case of a pre-existing JTA transaction.</span></span><br><span class="line">			<span class="keyword">boolean</span> newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</span><br><span class="line">			DefaultTransactionStatus status = newTransactionStatus(</span><br><span class="line">					definition, transaction, <span class="keyword">true</span>, newSynchronization, debugEnabled, <span class="keyword">null</span>);</span><br><span class="line">			doBegin(transaction, definition);</span><br><span class="line">			prepareSynchronization(status, definition);</span><br><span class="line">			<span class="keyword">return</span> status;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Assumably PROPAGATION_SUPPORTS or PROPAGATION_REQUIRED.</span></span><br><span class="line">	<span class="keyword">if</span> (debugEnabled) &#123;</span><br><span class="line">		logger.debug(<span class="string">"Participating in existing transaction"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (isValidateExistingTransaction()) &#123;</span><br><span class="line">		<span class="keyword">if</span> (definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT) &#123;</span><br><span class="line">			Integer currentIsolationLevel = TransactionSynchronizationManager.getCurrentTransactionIsolationLevel();</span><br><span class="line">			<span class="keyword">if</span> (currentIsolationLevel == <span class="keyword">null</span> || currentIsolationLevel != definition.getIsolationLevel()) &#123;</span><br><span class="line">				Constants isoConstants = DefaultTransactionDefinition.constants;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> IllegalTransactionStateException(<span class="string">"Participating transaction with definition ["</span> +</span><br><span class="line">						definition + <span class="string">"] specifies isolation level which is incompatible with existing transaction: "</span> +</span><br><span class="line">						(currentIsolationLevel != <span class="keyword">null</span> ?</span><br><span class="line">								isoConstants.toCode(currentIsolationLevel, DefaultTransactionDefinition.PREFIX_ISOLATION) :</span><br><span class="line">								<span class="string">"(unknown)"</span>));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!definition.isReadOnly()) &#123;</span><br><span class="line">			<span class="keyword">if</span> (TransactionSynchronizationManager.isCurrentTransactionReadOnly()) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> IllegalTransactionStateException(<span class="string">"Participating transaction with definition ["</span> +</span><br><span class="line">						definition + <span class="string">"] is not marked as read-only but existing transaction is"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">boolean</span> newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</span><br><span class="line">	<span class="function"><span class="keyword">return</span> <span class="title">prepareTransactionStatus</span><span class="params">(definition, transaction, <span class="keyword">false</span>, newSynchronization, debugEnabled, <span class="keyword">null</span>)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="u5177_u4F53_u4E8B_u52A1_u5904_u7406_u5668_u7684_u5B9E_u73B0"><a href="#u5177_u4F53_u4E8B_u52A1_u5904_u7406_u5668_u7684_u5B9E_u73B0" class="headerlink" title="具体事务处理器的实现"></a>具体事务处理器的实现 </h2><p> 下面，以 DataSourceTransactionManager 为例，简单介绍一下在具体的事务处理器中，是如何实现事务的创建、提交、<br>回滚这些底层的事务处理操作。在实现过程中，需要把数据库的 Connection 和当前的线程进行绑定。对于事务的提交 <br> 和回滚，都是直接调用 Connection 的提交和回滚方法来完成。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">DataSourceTransactionManager</span> <span class="keyword"><span class="keyword">extends</span></span> <span class="title">AbstractPlatformTransactionManager</span></span><br><span class="line"></span>		implements <span class="type">ResourceTransactionManager</span>, <span class="type">InitializingBean</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">DataSource</span> dataSource;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="type">Object</span> doGetTransaction() &#123;</span><br><span class="line">		<span class="type">DataSourceTransactionObject</span> txObject = <span class="keyword">new</span> <span class="type">DataSourceTransactionObject</span>();</span><br><span class="line">		txObject.setSavepointAllowed(isNestedTransactionAllowed());</span><br><span class="line">		<span class="type">ConnectionHolder</span> conHolder =</span><br><span class="line">				(<span class="type">ConnectionHolder</span>) <span class="type">TransactionSynchronizationManager</span>.getResource(<span class="keyword">this</span>.dataSource);</span><br><span class="line">		txObject.setConnectionHolder(conHolder, <span class="literal">false</span>);</span><br><span class="line">		<span class="keyword">return</span> txObject;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>TransactionSynchronizationManager 保存了线程级别的变量，当处于同一个事务的方法调用 doGetTransaction 时，getResource 方法返回的是同一个 ConnectionHolder</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> class TransactionSynchronizationManager &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(TransactionSynchronizationManager.class);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Map&lt;<span class="keyword">Object</span>, <span class="keyword">Object</span>&gt;&gt; resources =</span><br><span class="line">			<span class="keyword">new</span> NamedThreadLocal&lt;Map&lt;<span class="keyword">Object</span>, <span class="keyword">Object</span>&gt;&gt;(<span class="string">"Transactional resources"</span>);</span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Retrieve a resource for the given key that is bound to the current thread.</span><br><span class="line">	 * @param key the key to check (usually the resource factory)</span><br><span class="line">	 * @return a value bound to the current thread (usually the active</span><br><span class="line">	 * resource object), or &#123;@code null&#125; if none</span><br><span class="line">	 * @see ResourceTransactionManager#getResourceFactory()</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">Object</span> getResource(<span class="keyword">Object</span> <span class="variable">key</span>) &#123;</span><br><span class="line">		<span class="keyword">Object</span> actualKey = TransactionSynchronizationUtils.unwrapResourceIfNecessary(<span class="variable">key</span>);</span><br><span class="line">		<span class="keyword">Object</span> value = doGetResource(actualKey);</span><br><span class="line">		<span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; logger.isTraceEnabled()) &#123;</span><br><span class="line">			logger.trace(<span class="string">"Retrieved value ["</span> + value + <span class="string">"] for key ["</span> + actualKey + <span class="string">"] bound to thread ["</span> +</span><br><span class="line">					Thread.currentThread().getName() + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> value;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span><br><span class="line">	 * Actually check the value of the resource that is bound for the given key.</span><br><span class="line">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">Object</span> doGetResource(<span class="keyword">Object</span> actualKey) &#123;</span><br><span class="line">		Map&lt;<span class="keyword">Object</span>, <span class="keyword">Object</span>&gt; <span class="built_in">map</span> = resources.<span class="built_in">get</span>();</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">map</span> == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">Object</span> value = <span class="built_in">map</span>.<span class="built_in">get</span>(actualKey);</span><br><span class="line">		<span class="comment">// Transparently remove ResourceHolder that was marked as void...</span></span><br><span class="line">		<span class="keyword">if</span> (value <span class="keyword">instanceof</span> ResourceHolder &amp;&amp; ((ResourceHolder) value).isVoid()) &#123;</span><br><span class="line">			<span class="built_in">map</span>.remove(actualKey);</span><br><span class="line">			<span class="comment">// Remove entire ThreadLocal if empty...</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">map</span>.isEmpty()) &#123;</span><br><span class="line">				resources.remove();</span><br><span class="line">			&#125;</span><br><span class="line">			value = <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> value;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/dynamic-reconfiguration/">dynamic reconfiguration</a><a href="/tags/spring/">spring</a><a href="/tags/transacion/">transacion</a></div><div class="post-nav"><a href="/2015/11/19/fcws-api-doc/" class="pre"><i class="icon-previous">凤城卫士 API 文档</i></a><a href="/2015/11/09/devstack-1/" class="next">OpenStack 与 DevStack 初探<i class="icon-next"></i></a></div><div data-thread-key="2015/11/10/spring-transaction-manager/" data-title="Spring Transaction Manager 学习笔记" data-url="http://nap-blog.artemisprojects.org/2015/11/10/spring-transaction-manager/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2015/11/10/spring-transaction-manager/" data-title="Spring Transaction Manager 学习笔记" data-url="http://nap-blog.artemisprojects.org/2015/11/10/spring-transaction-manager/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search" class="search-form-input"/><input type="hidden" name="sitesearch" value="http://nap-blog.artemisprojects.org"/></form></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/OpenStack/">OpenStack</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/TVDCR/">TVDCR</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/east/">east</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nap/">nap</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/书架/">书架</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/未分类/">未分类</a></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/mesos/" style="font-size: 15px;">mesos</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/dynamic-reconfiguration/" style="font-size: 15px;">dynamic reconfiguration</a> <a href="/tags/restful/" style="font-size: 15px;">restful</a> <a href="/tags/rest/" style="font-size: 15px;">rest</a> <a href="/tags/OpenStack/" style="font-size: 15px;">OpenStack</a> <a href="/tags/Neutron/" style="font-size: 15px;">Neutron</a> <a href="/tags/floating-ip/" style="font-size: 15px;">floating-ip</a> <a href="/tags/nap/" style="font-size: 15px;">nap</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/compose/" style="font-size: 15px;">compose</a> <a href="/tags/transacion/" style="font-size: 15px;">transacion</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/Hive/" style="font-size: 15px;">Hive</a> <a href="/tags/Tez/" style="font-size: 15px;">Tez</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/api/" style="font-size: 15px;">api</a> <a href="/tags/ORM/" style="font-size: 15px;">ORM</a> <a href="/tags/nosql/" style="font-size: 15px;">nosql</a> <a href="/tags/schema/" style="font-size: 15px;">schema</a> <a href="/tags/east/" style="font-size: 15px;">east</a> <a href="/tags/openstack/" style="font-size: 15px;">openstack</a> <a href="/tags/devstack/" style="font-size: 15px;">devstack</a></div></div><div class="widget"><div class="widget-title">友情链接</div><ul></ul><a href="http://nap-blog.artemisprojects.org/2015/10/21/books/" title="����" target="_blank">����</a><ul></ul><a href="http://jetmuffin.github.io/" title="Jie CHEN" target="_blank">Jie CHEN</a><ul></ul><a href="http://cshuo.github.io/" title="Shuo CHEN" target="_blank">Shuo CHEN</a><ul></ul><a href="http://NAP-GHJ.github.io" title="Hongjun GE" target="_blank">Hongjun GE</a><ul></ul><a href="http://itanch.github.io" title="Tianchi LIU" target="_blank">Tianchi LIU</a><ul></ul><a href="http://Luziling.github.io" title="Ziling LU" target="_blank">Ziling LU</a><ul></ul><a href="http://dmemoing.github.io" title="Jing DENG" target="_blank">Jing DENG</a><ul></ul><a href="http://rdmclin2.github.io/" title="Chenglin MENG" target="_blank">Chenglin MENG</a><ul></ul><a href="http://co2y.github.io/" title="Weiyi WANG" target="_blank">Weiyi WANG</a><ul></ul><a href="http://qunnn41.github.io" title="Yiqun WANG" target="_blank">Yiqun WANG</a><ul></ul><a href="http://flyxu.github.io" title="Xiang XU" target="_blank">Xiang XU</a><ul></ul><a href="http://monkey-h.github.io/" title="Zhongliang YUAN" target="_blank">Zhongliang YUAN</a><ul></ul><a href="http://ying-zhang.github.io/" title="Ying ZHANG" target="_blank">Ying ZHANG</a></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/03/15/hadoop_hive_tez/">Hadoop, Hive, Tez 搭建笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/nap-doc/">NAP 使用手册</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/30/photos/">我们的 2015</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/18/hotSwapAgent-not/">Hotswap Agent 学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/10/zookeeper-note/">ZooKeeper 学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/02/openstack_neutron/">OpenStack 平台 Neutron 服务初探</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/20/openstack_floating_ip/">OpenStack 平台手动搭建以及 floating-ip 的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/19/fcws-api-doc/">凤城卫士 API 文档</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/10/spring-transaction-manager/">Spring Transaction Manager 学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/09/devstack-1/">OpenStack 与 DevStack 初探</a></li></ul></div><div class="widget"><div class="comments-title">最近评论</div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div></div></div></div><div id="footer">© <a href="/" rel="nofollow">NAP.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/totop.js" type="text/javascript"></script><script src="/js/fancybox.pack.js" type="text/javascript"></script>
<script src="/js/jquery.fancybox.js" type="text/javascript"></script><link rel="stylesheet" href="/css/jquery.fancybox.css" type="text/css"><script>var duoshuoQuery = {short_name:'yingz'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//dn-comment.qbox.me/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script></div></body></html>