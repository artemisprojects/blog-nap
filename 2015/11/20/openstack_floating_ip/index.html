<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description"/><title>OpenStack 平台手动搭建以及 floating-ip 的使用 | NAP</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/pure-min.css"/><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"/><link rel="stylesheet" type="text/css" href="/css/style.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">OpenStack 平台手动搭建以及 floating-ip 的使用</h1><a id="logo" href="/">NAP</a><p class="description">Next Application Platform</p></div><div id="nav-menu"><a href="/" class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/atom.xml"><i class="icon-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">OpenStack 平台手动搭建以及 floating-ip 的使用</h1><div class="post-meta">2015-11-20 | <span class="categories">分类于<a href="/categories/OpenStack/"> OpenStack</a></span></div><span data-thread-key="2015/11/20/openstack_floating_ip/" class="ds-thread-count"></span><div class="post-content"><blockquote>
<p>最近尝试着根据 OpenStack 官方网站的教程搭建一个简单的 OpenStack 集群，并且使用 floating-ip 机制。下面简单对这些工作进行介绍。</p>
</blockquote>
<a id="more"></a>
<hr>
<h2 id="u642D_u5EFAOpenStack_u5E73_u53F0"><a href="#u642D_u5EFAOpenStack_u5E73_u53F0" class="headerlink" title="搭建 OpenStack 平台"></a>搭建 OpenStack 平台 </h2><h3 id="u5F00_u59CB_u4E4B_u524D"><a href="#u5F00_u59CB_u4E4B_u524D" class="headerlink" title="开始之前"></a> 开始之前 </h3><p> 在上一篇中，对 OpenStack 平台做了简单的介绍。这一次，我们根据 OpenStack 官网上面的 <a href="http://docs.openstack.org/liberty/install-guide-ubuntu/" target="_blank" rel="external"> 文档</a>，手动部署 OpenStack 中的服务组件。并在搭建好的平台上运行实例。平台的设计布局如下图所示：</p>
<p><img src="/images/openstack-layout.png" alt=""></p>
<p>在上图中，主要包括一个 Controller 节点和 Compute 节点，以及一些 Storage 节点。在本例中我们仅仅关注 Controller 节点和 Compute 节点。从图中可以看出 Controller 和 Compute 节点均包括两个子网，分别为 management network 和 public network。</p>
<p>我们使用 <a href="https://www.vagrantup.com/" target="_blank" rel="external">Vagrant</a> 工具初始化两个节点。Vagrantfile 具体为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Vagrant.configure(2) <span class="operator"><span class="keyword">do</span> |config|</span><br><span class="line">	config.vm.box = <span class="string">"ubuntu/trusty64"</span></span><br><span class="line"> 	config.vm.hostname = <span class="string">"controller"</span></span><br><span class="line">	config.ssh.username = <span class="string">"vagrant"</span></span><br><span class="line">	config.ssh.<span class="keyword">password</span> = <span class="string">"vagrant"</span></span><br><span class="line">   </span><br><span class="line">	config.vm.network <span class="string">"private_network"</span>, ip: <span class="string">"10.0.0.11"</span></span><br><span class="line">	config.vm.network <span class="string">"public_network"</span></span><br><span class="line">	</span><br><span class="line">	config.vm.provider <span class="string">"virtualbox"</span> <span class="keyword">do</span> |vb|</span><br><span class="line">		vb.gui = <span class="literal">false</span></span><br><span class="line">		vb.<span class="keyword">memory</span> = <span class="string">"6144"</span></span><br><span class="line">		vb.cpus = <span class="number">2</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span></span><br></pre></td></tr></table></figure>
<p>我们建立的虚拟机是 Ubuntu14.04 64 位，还有一些关于主机名，用户密码，内存，CPU 的简单设置。我们设置了两个网络，分别对应于 management work 和 public network。</p>
<h3 id="u51C6_u5907_u5DE5_u4F5C"><a href="#u51C6_u5907_u5DE5_u4F5C" class="headerlink" title="准备工作"></a>准备工作 </h3><p> 在安装 OpenStack 的各个服务组件之前，需要预先安装一些软件。</p>
<ul>
<li><a href="http://docs.openstack.org/liberty/install-guide-ubuntu/environment-ntp.html" target="_blank" rel="external">NTP 协议</a>，用于同步不同节点之间的状态及服务。</li>
<li><a href="http://docs.openstack.org/liberty/install-guide-ubuntu/environment-packages.html" target="_blank" rel="external">OpenStack 包</a>，安装最新的 OpenStack 包，这里我们选取的是最新版 Liberty。</li>
<li><a href="http://docs.openstack.org/liberty/install-guide-ubuntu/environment-sql-database.html" target="_blank" rel="external">SQL 数据库</a>，在 Controller 节点上安装 SQL 数据库，大多数 OpenStack 服务使用 SQL 数据库用来存储信息。</li>
<li><a href="http://docs.openstack.org/liberty/install-guide-ubuntu/environment-nosql-database.html" target="_blank" rel="external">NoSQL 数据库 </a>，在 Controller 节点上安装，Telemetry 服务使用 NoSQL 数据库(一般为 MongoDB) 来存储消息。</li>
<li><a href="http://docs.openstack.org/liberty/install-guide-ubuntu/environment-messaging.html" target="_blank" rel="external">消息队列</a>，在 Controller 节点上安装，OpenStack 平台使用消息队列来协调各个服务之间的操作和状态信息。</li>
</ul>
<h3 id="u5B89_u88C5Keystone_u7EC4_u4EF6"><a href="#u5B89_u88C5Keystone_u7EC4_u4EF6" class="headerlink" title="安装 Keystone 组件"></a>安装 Keystone 组件 </h3><p>OpenStack 平台中的 Keystone 服务主要用于身份管理，Keystone 的作用类似与一个服务总线，其他服务都通过 Keystone 来注册器服务的 Endpoint，针对这些服务的任何调用都需要经过 Keystone 的身份认证才可以。安装的步骤按照<a href="http://docs.openstack.org/liberty/install-guide-ubuntu/common/get_started_identity.html" target="_blank" rel="external"> 文档 </a> 中进行即可。</p>
<h3 id="u5B89_u88C5Glance_u7EC4_u4EF6"><a href="#u5B89_u88C5Glance_u7EC4_u4EF6" class="headerlink" title="安装 Glance 组件"></a>安装 Glance 组件 </h3><p>OpenStack 平台中的 Glance 服务主要管理镜像。这点跟 Docker 中的 image 类似。即我们可以上传当前的镜像以便日后使用。安装的步骤按照<a href="http://docs.openstack.org/liberty/install-guide-ubuntu/glance.html" target="_blank" rel="external"> 文档 </a> 中进行即可。</p>
<h3 id="u5B89_u88C5Nova_u7EC4_u4EF6"><a href="#u5B89_u88C5Nova_u7EC4_u4EF6" class="headerlink" title="安装 Nova 组件"></a>安装 Nova 组件 </h3><p>OpenStack 平台中的 Nova 服务是 OpenStack 平台的核心服务，它用于抽象虚拟机实例，并控制着虚拟机的状态便签，管理着它们的资源分配。安装的步骤按照<a href="http://docs.openstack.org/liberty/install-guide-ubuntu/nova.html" target="_blank" rel="external"> 文档 </a> 中进行，其中有一个地方文档写错了，我们会在后面详细说一下。</p>
<h3 id="u5B89_u88C5Neutron_u7EC4_u4EF6"><a href="#u5B89_u88C5Neutron_u7EC4_u4EF6" class="headerlink" title="安装 Neutron 组件"></a>安装 Neutron 组件 </h3><p>OpenStack 平台中的 Neutron 服务将 OpenStack 平台所在的物理网络泛化为网络资源池，通过对物理网络资源的灵活划分与管理，Neutron 组件能为同一物理网络上的每个 tenant 提供独立的虚拟网络环境。安装的步骤按照<a href="http://docs.openstack.org/liberty/install-guide-ubuntu/neutron.html" target="_blank" rel="external"> 文档 </a> 中进行即可。安装后的网络模块大致如下：</p>
<p><img src="/images/openstack-network-overview.png" alt=""></p>
<p>其中 Controller 中有网桥代理，Metadata 代理，DHCP 代理和 L3 代理，而 Compute 节点中只有网桥代理。</p>
<h3 id="u5B89_u88C5Horizon_u7EC4_u4EF6"><a href="#u5B89_u88C5Horizon_u7EC4_u4EF6" class="headerlink" title="安装 Horizon 组件"></a>安装 Horizon 组件 </h3><p>OpenStack 平台中的 Horizon 提供了 Dashboard，即一个简洁方便用户友好的控制界面，让开发者和使用者更好的浏览并操作属于自己的计算资源，安装步骤按照<a href="http://docs.openstack.org/liberty/install-guide-ubuntu/horizon.html" target="_blank" rel="external"> 文档 </a> 中进行即可。</p>
<h3 id="u8FD0_u884C_u4E00_u4E2A_u4F8B_u5B50"><a href="#u8FD0_u884C_u4E00_u4E2A_u4F8B_u5B50" class="headerlink" title="运行一个例子"></a>运行一个例子 </h3><p> 在此之前，我们按照文档已经安装好了 OpenStack 平台最基本的一些服务，下面我们就可以运行一个 <a href="http://docs.openstack.org/liberty/install-guide-ubuntu/launch-instance.html" target="_blank" rel="external"> 例子</a>。在安装 Neutron 服务后，集群的网络拓扑为下图。</p>
<p><img src="/images/openstack-network-connect.png" alt=""></p>
<p>其中 public provider network 和 public physical network 应该在同一个网段内，management physical network 是启动虚拟机的 Vagrantfile 中已经预先定义好了。Private project network 需要自己手动创建，在文档中有例子，这个网段应该可以是任意指定的。 我们一共运行了两个实例，一个为公共实例，一个为私有实例，公共实例可以通过 ip 地址直接 ssh 访问 (因为在同一子网内)，但是私有实例则需要指定 floating-ip，才能访问。把 floating-ip 的介绍的<a href="https://www.rdoproject.org/networking/difference-between-floating-ip-and-private-ip/" target="_blank" rel="external"> 链接 1</a> <a href="http://docs.openstack.org/user-guide/cli_manage_ip_addresses.html" target="_blank" rel="external">链接 2</a>放出来，供大家参考。</p>
<p><img src="/images/openstack-network-instance.png" alt=""></p>
<p>如果想要访问私有实例 private-instance，由于分配了 floating-ip，所以它的访问过程如下图所示：</p>
<p><img src="/images/openstack-floating-ip.png" alt=""></p>
<h2 id="u5B89_u88C5_u8FC7_u7A0B_u9047_u5230_u7684_u95EE_u9898_u603B_u7ED3"><a href="#u5B89_u88C5_u8FC7_u7A0B_u9047_u5230_u7684_u95EE_u9898_u603B_u7ED3" class="headerlink" title="安装过程遇到的问题总结"></a>安装过程遇到的问题总结</h2><ul>
<li>首先在安装完 Compute 服务后，发现在 Controller 节点上并没有显示出 Compute 节点上面的 nova-compute 服务，在网上找了一下原因。有的大神提出来在配置文件 /etc/nova/nova.conf 中，关于消息队列的三个配置项不应该在 <code>[oslo_messaging_rabbit]</code> 这个 section 中，应该在 <code>[DEFAULT]</code> 中，修改后重启 nova-compute 服务即可。在重启后，在 Controller 节点上发现 nova-compute 服务，状态为 up，但是过了一会儿状态变为 down 了。不知道为什么，在网上找了很久也没有解决。于是把 Compute 节点删掉，重新装了一遍，就好了。好了。了。</li>
<li>安装完 DashBoard 组件后，可以正常登陆，但是在打开 <code>Instance</code> 列表时，右上角会出现 <strong>Unable to Connect to Neutron</strong> 的提示，而且不能通过在 DashBoard 页面创建实例等。这是因为我在刚开始装 Neutron 组件的时候选择了 <a href="http://docs.openstack.org/liberty/install-guide-ubuntu/neutron-controller-install-option1.html" target="_blank" rel="external">Provider networks</a> 这个选项，在配置文件 /etc/neutron/neutron.conf 文件中，它禁用了 service_plugins 这个选项，即把它赋值为空。但是在第二个选项 <a href="http://docs.openstack.org/liberty/install-guide-ubuntu/neutron-controller-install-option2.html" target="_blank" rel="external">Self-service networks</a> 中，这一项赋值为 router。由于后来要使用 floating-ip 机制，所以需要选择第二个网络拓扑，就把这一项填充好了。然后之前页面上的问题也成功解决了。</li>
<li>在运行的例子中，由于我们最后选择的是第二项网络拓扑，所以运行的实例不论是共有 (public instance) 的还是私有 (private instance) 的，都应该可以正常运行。但是我们只能成功运行私有实例，并可以使用 floating-ip 机制访问进新建的 private 虚拟机实例。而公共实例却不能正常访问，这是因为虚拟机在启动的时候 DHCP 没有分配好 IP 地址，所以尽管我们在 DashBoard 中发现这个实例已经有了 IP 地址，但是通过 console 进入虚拟机之后发现并没有分配正确的 ip 地址。通过实例的 log 分析，应该是 DHCP 的配置出了一些问题，也在网上找了很久，都没有找到解决办法。</li>
</ul>
</div><div class="tags"><a href="/tags/OpenStack/">OpenStack</a><a href="/tags/floating-ip/">floating-ip</a></div><div class="post-nav"><a href="/2015/12/02/openstack_neutron/" class="pre"><i class="icon-previous">OpenStack 平台 Neutron 服务初探</i></a><a href="/2015/11/19/fcws-api-doc/" class="next">凤城卫士 API 文档<i class="icon-next"></i></a></div><div data-thread-key="2015/11/20/openstack_floating_ip/" data-title="OpenStack 平台手动搭建以及 floating-ip 的使用" data-url="http://nap-blog.artemisprojects.org/2015/11/20/openstack_floating_ip/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2015/11/20/openstack_floating_ip/" data-title="OpenStack 平台手动搭建以及 floating-ip 的使用" data-url="http://nap-blog.artemisprojects.org/2015/11/20/openstack_floating_ip/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search" class="search-form-input"/><input type="hidden" name="sitesearch" value="http://nap-blog.artemisprojects.org"/></form></div><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/OpenStack/">OpenStack</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/TVDCR/">TVDCR</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/east/">east</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nap/">nap</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/未分类/">未分类</a></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/mesos/" style="font-size: 15px;">mesos</a> <a href="/tags/spring/" style="font-size: 15px;">spring</a> <a href="/tags/dynamic-reconfiguration/" style="font-size: 15px;">dynamic reconfiguration</a> <a href="/tags/restful/" style="font-size: 15px;">restful</a> <a href="/tags/rest/" style="font-size: 15px;">rest</a> <a href="/tags/OpenStack/" style="font-size: 15px;">OpenStack</a> <a href="/tags/Neutron/" style="font-size: 15px;">Neutron</a> <a href="/tags/floating-ip/" style="font-size: 15px;">floating-ip</a> <a href="/tags/nap/" style="font-size: 15px;">nap</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/compose/" style="font-size: 15px;">compose</a> <a href="/tags/transacion/" style="font-size: 15px;">transacion</a> <a href="/tags/hadoop/" style="font-size: 15px;">hadoop</a> <a href="/tags/Hive/" style="font-size: 15px;">Hive</a> <a href="/tags/Tez/" style="font-size: 15px;">Tez</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/api/" style="font-size: 15px;">api</a> <a href="/tags/ORM/" style="font-size: 15px;">ORM</a> <a href="/tags/nosql/" style="font-size: 15px;">nosql</a> <a href="/tags/schema/" style="font-size: 15px;">schema</a> <a href="/tags/east/" style="font-size: 15px;">east</a> <a href="/tags/openstack/" style="font-size: 15px;">openstack</a> <a href="/tags/devstack/" style="font-size: 15px;">devstack</a></div></div><div class="widget"><div class="widget-title">友情链接</div><ul></ul><a href="http://artemisprojects.org/" title="Artemis Projects" target="_blank">Artemis Projects</a><ul></ul><a href="http://www.nju.edu.cn/" title="Nanjing Univ." target="_blank">Nanjing Univ.</a><ul></ul><a href="http://chun.nemoworks.info/" title="Chun CAO" target="_blank">Chun CAO</a><ul></ul><a href="http://jetmuffin.github.io/" title="Jie CHEN" target="_blank">Jie CHEN</a><ul></ul><a href="http://cshuo.github.io/" title="Shuo CHEN" target="_blank">Shuo CHEN</a><ul></ul><a href="http://NAP-GHJ.github.io" title="Hongjun GE" target="_blank">Hongjun GE</a><ul></ul><a href="http://itanch.github.io" title="Tianchi LIU" target="_blank">Tianchi LIU</a><ul></ul><a href="http://Luziling.github.io" title="Ziling LU" target="_blank">Ziling LU</a><ul></ul><a href="http://dmemoing.github.io" title="Jing DENG" target="_blank">Jing DENG</a><ul></ul><a href="http://rdmclin2.github.io/" title="Chenglin MENG" target="_blank">Chenglin MENG</a><ul></ul><a href="http://co2y.github.io/" title="Weiyi WANG" target="_blank">Weiyi WANG</a><ul></ul><a href="http://qunnn41.github.io" title="Yiqun WANG" target="_blank">Yiqun WANG</a><ul></ul><a href="http://flyxu.github.io" title="Xiang XU" target="_blank">Xiang XU</a><ul></ul><a href="http://monkey-h.github.io/" title="Zhongliang YUAN" target="_blank">Zhongliang YUAN</a><ul></ul><a href="http://ying-zhang.github.io/" title="Ying ZHANG" target="_blank">Ying ZHANG</a></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/03/15/hadoop_hive_tez/">Hadoop, Hive, Tez 搭建笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/10/nap-doc/">NAP 使用手册</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/30/photos/">我们的 2015</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/18/hotSwapAgent-not/">Hotswap Agent 学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/10/zookeeper-note/">ZooKeeper 学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/02/openstack_neutron/">OpenStack 平台 Neutron 服务初探</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/20/openstack_floating_ip/">OpenStack 平台手动搭建以及 floating-ip 的使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/19/fcws-api-doc/">凤城卫士 API 文档</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/10/spring-transaction-manager/">Spring Transaction Manager 学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/09/devstack-1/">OpenStack 与 DevStack 初探</a></li></ul></div><div class="widget"><div class="comments-title">最近评论</div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div></div></div></div><div id="footer">© <a href="/" rel="nofollow">NAP.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/totop.js" type="text/javascript"></script><script src="/js/fancybox.pack.js" type="text/javascript"></script>
<script src="/js/jquery.fancybox.js" type="text/javascript"></script><link rel="stylesheet" href="/css/jquery.fancybox.css" type="text/css"><script>var duoshuoQuery = {short_name:'yingz'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//dn-comment.qbox.me/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script></div></body></html>